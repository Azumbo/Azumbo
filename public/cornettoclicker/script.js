const translations = {
  en: {
    "nav.game": "ABOUT GAME",
    "nav.biz": "FOR BUSINESS",
    "nav.download": "DOWNLOAD",
    "hero.subtitle": "LEGENDARY CLICKER IS BACK!",
    "hero.play": "PLAY NOW",
    "features.title": "GAME FEATURES",
    "features.f1": "50+ ice creams",
    "features.f2": "Retro achievements",
    "features.f3": "Cross-platform",
    "biz.title": "WANT THIS GAME FOR YOUR BUSINESS?",
    "biz.bakery": "BAKERY \u2192 CROISSANTS",
    "biz.winery": "WINERY \u2192 GRAPES",
    "biz.brewery": "BREWERY \u2192 BOTTLES",
    "biz.cafe": "CAFE \u2192 COOKIES",
    "biz.offer_title": "YOUR BRANDED GAME IN 7 DAYS:",
    "biz.offer1": "Logo & brand colors",
    "biz.offer2": "Custom collectibles",
    "biz.offer3": "Web + iOS + Android",
    "biz.offer4": "Retro sounds",
    "biz.cta_text": "Want more loyal customers? Let them play!",
    "biz.cta_btn": "ORDER NOW"
  },
  ru: {
    "nav.game": "\u041E \u0418\u0413\u0420\u0415",
    "nav.biz": "\u0414\u041B\u042F \u0411\u0418\u0417\u041D\u0415\u0421\u0410",
    "nav.download": "\u0421\u041A\u0410\u0427\u0410\u0422\u042C",
    "hero.subtitle": "\u041B\u0415\u0413\u0415\u041D\u0414\u0410\u0420\u041D\u042B\u0419 \u041A\u041B\u0418\u041A\u0415\u0420 \u0412\u0415\u0420\u041D\u0423\u041B\u0421\u042F!",
    "hero.play": "\u0418\u0413\u0420\u0410\u0422\u042C",
    "features.title": "\u041E\u0421\u041E\u0411\u0415\u041D\u041D\u041E\u0421\u0422\u0418 \u0418\u0413\u0420\u042B",
    "features.f1": "50+ \u043C\u043E\u0440\u043E\u0436\u0435\u043D\u044B\u0445",
    "features.f2": "\u0420\u0435\u0442\u0440\u043E \u0434\u043E\u0441\u0442\u0438\u0436\u0435\u043D\u0438\u044F",
    "features.f3": "\u041A\u0440\u043E\u0441\u0441-\u043F\u043B\u0430\u0442\u0444\u043E\u0440\u043C\u0435\u043D\u043D\u043E",
    "biz.title": "\u0425\u041E\u0422\u0418\u0422\u0415 \u042D\u0422\u0423 \u0418\u0413\u0420\u0423 \u0414\u041B\u042F \u0412\u0410\u0428\u0415\u0413\u041E \u0411\u0418\u0417\u041D\u0415\u0421\u0410?",
    "biz.bakery": "\u041F\u0415\u041A\u0410\u0420\u041D\u042F \u2192 \u041A\u0420\u0423\u0410\u0421\u0421\u0410\u041D\u042B",
    "biz.winery": "\u0412\u0418\u041D\u041E\u0414\u0415\u041B\u042C\u041D\u042F \u2192 \u0412\u0418\u041D\u041E\u0413\u0420\u0410\u0414",
    "biz.brewery": "\u041F\u0418\u0412\u041E\u0412\u0410\u0420\u041D\u042F \u2192 \u0411\u0423\u0422\u042B\u041B\u041A\u0418",
    "biz.cafe": "\u041A\u0410\u0424\u0415 \u2192 \u041F\u0415\u0427\u0415\u041D\u042C\u0415",
    "biz.offer_title": "\u0412\u0410\u0428\u0410 \u0411\u0420\u0415\u041D\u0414\u0418\u0420\u041E\u0412\u0410\u041D\u041D\u0410\u042F \u0418\u0413\u0420\u0410 \u0417\u0410 7 \u0414\u041D\u0415\u0419:",
    "biz.offer1": "\u041B\u043E\u0433\u043E \u0438 \u0446\u0432\u0435\u0442\u0430",
    "biz.offer2": "\u041A\u0430\u0441\u0442\u043E\u043C\u043D\u044B\u0435 \u043D\u0430\u0445\u043E\u0434\u043A\u0438",
    "biz.offer3": "Web + iOS + Android",
    "biz.offer4": "\u0420\u0435\u0442\u0440\u043E \u0437\u0432\u0443\u043A\u0438",
    "biz.cta_text": "\u041D\u0443\u0436\u043D\u043E \u0431\u043E\u043B\u044C\u0448\u0435 \u043B\u043E\u044F\u043B\u044C\u043D\u044B\u0445 \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432? \u041F\u0443\u0441\u0442\u044C \u0438\u0433\u0440\u0430\u044E\u0442!",
    "biz.cta_btn": "\u0417\u0410\u041A\u0410\u0417\u0410\u0422\u042C"
  },
  it: {
    "nav.game": "GIOCO",
    "nav.biz": "PER AZIENDE",
    "nav.download": "SCARICA",
    "hero.subtitle": "IL CLICKER LEGGENDARIO \u00C8 TORNATO!",
    "hero.play": "GIOCA ORA",
    "features.title": "FUNZIONALIT\u00C0 DEL GIOCO",
    "features.f1": "Pi\u00F9 di 50 gelati",
    "features.f2": "Obiettivi retr\u00F2",
    "features.f3": "Multipiattaforma",
    "biz.title": "VUOI QUESTO GIOCO PER LA TUA ATTIVIT\u00C0?",
    "biz.bakery": "PANIFICIO \u2192 CROISSANT",
    "biz.winery": "CANTINA \u2192 UVA",
    "biz.brewery": "BIRRERIA \u2192 BOTTIGLIE",
    "biz.cafe": "CAFF\u00C8 \u2192 BISCOTTI",
    "biz.offer_title": "IL TUO GIOCO BRANDIZZATO IN 7 GIORNI:",
    "biz.offer1": "Logo e colori brand",
    "biz.offer2": "Collezionabili personalizzati",
    "biz.offer3": "Web + iOS + Android",
    "biz.offer4": "Suoni retr\u00F2",
    "biz.cta_text": "Vuoi pi\u00F9 clienti fedeli? Fai giocare!",
    "biz.cta_btn": "ORDINA ORA"
  }
};

function setLanguage(lang) {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (translations[lang] && translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
  localStorage.setItem('lang', lang);
}

function initLanguage() {
  const saved = localStorage.getItem('lang');
  let lang = saved || navigator.language.slice(0,2);
  if(!translations[lang]) lang = 'en';
  setLanguage(lang);
}

document.querySelectorAll('.lang-switcher button').forEach(btn => {
  btn.addEventListener('click', () => {
    setLanguage(btn.dataset.lang);
  });
});

document.getElementById('year').textContent = new Date().getFullYear();

// Mini game trigger
let clickCount = 0;
document.querySelector('.pixel-logo').addEventListener('click', () => {
  clickCount++;
  if (clickCount >= 5) launchMiniGame();
});

function launchMiniGame() {
  // create overlay and canvas
  const overlay = document.createElement('div');
  overlay.id = 'game-overlay';
  Object.assign(overlay.style, {
    position: 'fixed',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
    background: 'rgba(0,0,0,0.9)',
    zIndex: 9998,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: '#41ead4',
    fontFamily: '"Press Start 2P", monospace',
    textAlign: 'center',
    flexDirection: 'column'
  });

  const canvas = document.createElement('canvas');
  canvas.width = 640;
  canvas.height = 360;
  canvas.style.imageRendering = 'pixelated';
  canvas.style.background = '#0d1b2a';
  canvas.style.border = '2px solid #ff206e';
  overlay.appendChild(canvas);
  document.body.appendChild(overlay);

  const ctx = canvas.getContext('2d');

  let gameState = 'splash';
  let score = 0;
  let timeLeft = 30;
  let croissants = [];
  let hiScore = parseInt(localStorage.getItem('cornettoHiScore') || '42', 10);

  const player = { x: canvas.width / 2, y: canvas.height - 30, w: 40, h: 20 };
  let left = false;
  let right = false;

  function drawSplash() {
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#41ead4';
    ctx.font = '18px "Press Start 2P"';
    ctx.fillText('=== CORNETTO CHALLENGE ===', 40, 120);
    ctx.fillText('CATCH 20 CROISSANTS!', 90, 160);
    ctx.fillText('PRESS [SPACE] TO START', 60, 200);
  }

  function spawnCroissant() {
    if (Math.random() < 0.05) {
      croissants.push({
        x: Math.random() * (canvas.width - 20) + 10,
        y: -10,
        type: Math.random() > 0.8 ? 'GOLDEN' : (Math.random() < 0.1 ? 'BURNT' : 'NORMAL'),
        speed: 2 + Math.random() * 2
      });
    }
  }

  function drawPlayer() {
    ctx.fillStyle = '#ff9e00';
    ctx.fillRect(player.x - player.w / 2, player.y, player.w, player.h);
  }

  function drawCroissants() {
    croissants.forEach(obj => {
      if (obj.type === 'GOLDEN') ctx.fillStyle = '#ff9e00';
      else if (obj.type === 'BURNT') ctx.fillStyle = '#552200';
      else ctx.fillStyle = '#f8f8f8';
      ctx.beginPath();
      ctx.arc(obj.x, obj.y, 10, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function moveCroissants() {
    croissants.forEach(obj => obj.y += obj.speed);
    croissants = croissants.filter(obj => obj.y < canvas.height + 20);
  }

  function checkCollisions() {
    croissants.forEach((obj, index) => {
      if (obj.y + 10 >= player.y && Math.abs(obj.x - player.x) < (player.w / 2 + 10)) {
        if (obj.type === 'GOLDEN') score += 5;
        else if (obj.type === 'BURNT') score -= 2;
        else score += 1;
        croissants.splice(index, 1);
      }
    });
  }

  function drawHUD() {
    ctx.fillStyle = '#41ead4';
    ctx.font = '14px "Press Start 2P"';
    ctx.fillText(`SCORE: ${score}`, 20, 30);
    ctx.fillText(`TIME: ${timeLeft}`, canvas.width - 150, 30);
    ctx.fillText(`HI-SCORE: ${hiScore}`, 20, 50);
  }

  function updatePlayer() {
    if (left) player.x -= 4;
    if (right) player.x += 4;
    if (player.x < 20) player.x = 20;
    if (player.x > canvas.width - 20) player.x = canvas.width - 20;
  }

  function update() {
    spawnCroissant();
    moveCroissants();
    updatePlayer();
    checkCollisions();
  }

  function render() {
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawPlayer();
    drawCroissants();
    drawHUD();
  }

  let timer;
  function gameLoop() {
    if (gameState !== 'playing') return;
    update();
    render();
    requestAnimationFrame(gameLoop);
  }

  function startGame() {
    gameState = 'playing';
    drawHUD();
    timer = setInterval(() => {
      timeLeft--;
      if (timeLeft <= 0) endGame();
    }, 1000);
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    clearInterval(timer);
    gameState = 'gameover';
    if (score > hiScore) {
      hiScore = score;
      localStorage.setItem('cornettoHiScore', String(hiScore));
    }
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#41ead4';
    ctx.font = '18px "Press Start 2P"';
    ctx.fillText('GAME OVER!', 220, 150);
    ctx.fillText(`YOUR SCORE: ${score}`, 160, 190);
    ctx.fillText('UNLOCKED: "BAKER" BADGE!', 80, 230);
    ctx.fillText('PRESS SPACE TO EXIT', 120, 270);
    localStorage.setItem('unlockedBadge', 'BAKER');
  }

  function cleanup() {
    document.removeEventListener('keydown', keyHandler);
    document.removeEventListener('keyup', keyUpHandler);
    document.removeEventListener('mousemove', mouseHandler);
    overlay.remove();
    clickCount = 0;
  }

  function keyHandler(e) {
    if (gameState === 'splash' && e.code === 'Space') {
      startGame();
    } else if (gameState === 'playing') {
      if (e.code === 'ArrowLeft') left = true;
      if (e.code === 'ArrowRight') right = true;
    } else if (gameState === 'gameover' && e.code === 'Space') {
      cleanup();
    }
  }

  function keyUpHandler(e) {
    if (e.code === 'ArrowLeft') left = false;
    if (e.code === 'ArrowRight') right = false;
  }

  function mouseHandler(e) {
    const rect = canvas.getBoundingClientRect();
    player.x = e.clientX - rect.left;
  }

  document.addEventListener('keydown', keyHandler);
  document.addEventListener('keyup', keyUpHandler);
  document.addEventListener('mousemove', mouseHandler);

  drawSplash();
}

// Konami code
const konami = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
let kIndex = 0;
document.addEventListener('keydown', e => {
  if (e.key === konami[kIndex]) {
    kIndex++;
    if (kIndex === konami.length) {
      launchMiniGame();
      kIndex = 0;
    }
  } else {
    kIndex = 0;
  }
});

function secretGame() {
  launchMiniGame();
}

window.addEventListener('load', initLanguage);

const hoverAudio = new Audio('hover.mp3');
document.querySelectorAll('.pixel-btn').forEach(btn => {
  btn.addEventListener('mouseenter', () => hoverAudio.play());
});
